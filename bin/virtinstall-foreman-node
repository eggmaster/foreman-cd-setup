#!/bin/bash

KS_URL=https://raw.github.com/eggmaster/foreman-cd-setup/master/kickstarts/astapor-provision-noproxy.cfg
if [ "$1" = "--proxy" ]
then
KS_URL=https://raw.github.com/eggmaster/foreman-cd-setup/master/kickstarts/astapor-provision-proxy.cfg
iptables -I INPUT 1 -p tcp --dport 3128 --src $FOREMAN_PUB.0/24 -j ACCEPT
fi


if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root" 1>&2
   exit 1
fi

virsh list | grep "[[:space:]]$VM_NAME[[:space:]]" | awk '{print $1}' | while read n; do virsh destroy $n; done && virsh undefine $VM_NAME --remove-all-storage

virt-install --connect qemu:///system --virt-type kvm --name $VM_NAME --ram 2048 \
      --disk pool=poolio,size=40 \
      --network network=foreman_public \
      --network network=foreman_pxe \
      --graphics vnc \
      --location http://download.devel.redhat.com/released/RHEL-6/6.4/Server/x86_64/os/ \
      --os-variant rhel6 \
      --extra-args "ks=$KS_URL ksdevice=eth0 gateway=$FOREMAN_PUB.1 ip=$FOREMAN_PUB.20 netmask=255.255.255.0 dns=$FOREMAN_PUB.1 noverifyssl"
